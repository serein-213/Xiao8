<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D æœ¬åœ°æ¨¡å‹æŸ¥çœ‹å™¨ (ä¿®æ­£ç‰ˆ)</title>
    <style>
        /* CSSæ ·å¼éƒ¨åˆ†ä¿æŒä¸å˜ */
        html, body {
            height: 100%; margin: 0; padding: 0; background: #fff; color: #222;
            font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden;
        }
        #live2d-container {
            position: fixed; right: 0px; bottom: 0px; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
        }
        #live2d-canvas {
            display: block; width: 100%; height: 100%; background: transparent;
            cursor: grab; pointer-events: auto;
        }
        #live2d-canvas:active { cursor: grabbing; }
        #chat-container { pointer-events: auto; position: fixed; left: 20px; bottom: 20px; width: 340px;
            height: 300px; background: #f7f8fa; opacity: 0.7; border-radius: 12px; padding: 16px;
            box-sizing: border-box; z-index: 20; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: flex; flex-direction: column; }
        #chat-content-wrapper { flex-grow: 1; padding-left: 8px; overflow-y: auto; opacity: 0.7; }
        #sidebar {
            /*background: #f7f8fa;*/
            /*opacity: 0.7;*/
            border-radius: 12px;
            box-sizing: border-box;
            box-shadow: None;

            background: transparent;
            position: fixed;
            left: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 20;
            min-width: 150px;
            transition: width 0.3s ease, min-width 0.3s ease, height 0.3s ease, padding 0.3s ease, opacity 0.3s;
        }
        .side-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #333;
            color: #fff; font-size: 1rem; cursor: pointer; margin-bottom: 4px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s; }
        .side-btn:active {
            background: #555;
        }

        .side-btn:disabled {
            background: #e0e0e0;
            color: #888;
            cursor: not-allowed;
            border: 1px solid #ccc;
            opacity: 0.7;
        }

        .side-btn:hover:not(:disabled) {
            background: #4f8cff;
            color: #fff;
        }
        #status {
            /*margin-top: 5px;*/
            color: #4f8cff;
            background: transparent;
            font-size: 0.95rem;
            max-width: 150px;
            word-break: break-all;
        }
        #model-list-container { display: none; flex-direction: column; gap: 8px; margin-top: 10px; width: 130px;}
        .model-select-btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc;
            background: #fff; cursor: pointer; text-align: left; }
        .model-select-btn:hover { background: #e8f0fe; border-color: #4f8cff; }
        .save-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #4f8cff;
            color: #fff; font-size: 1rem; cursor: pointer; margin-bottom: 4px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s; }
        .save-btn:hover { background: #2662c8; }
        .save-btn:disabled { background: #b0c4de; cursor: not-allowed; }
    </style>
</head>
<body>

<div id="sidebar">
    <button id="changeModelBtn" class="side-btn">ğŸ”„ï¸ æ›´æ¢æ¨¡å‹</button>
    <div id="model-list-container"></div>
    <button id="savePreferencesBtn" class="save-btn" disabled>ğŸ’¾ ä¿å­˜è®¾ç½®</button>
    <button id="micButton" class="side-btn" disabled>ğŸ¤ å¼€å§‹èŠå¤©</button>
    <button id="muteButton" class="side-btn" disabled>â¸ï¸ ä¼‘æ¯ä¸€ä¸‹</button>
    <div id="status">æ­£åœ¨ä»æœåŠ¡å™¨è·å–æ¨¡å‹åˆ—è¡¨...</div>
    <!-- <button id="screenButton" class="side-btn" disabled>ğŸ–¥ï¸ å±å¹•å…±äº«</button>
    <button id="stopButton" class="side-btn" disabled>ğŸ›‘ æš‚åœå…±äº«</button> -->
    <!-- <button id="resetSessionButton" class="side-btn" disabled>ğŸ‘‹ è¯·å¥¹ç¦»å¼€</button> -->
</div>
<div id="chat-container">
    <div id="chat-content-wrapper"><p style="color: #888">å¯¹è¯å†å²ç•Œé¢<br><br>...ç°åœ¨æ˜¯ä¸€ç‰‡ç©ºç™½...</p></div>
</div>
<div id="live2d-container"><canvas id="live2d-canvas"></canvas></div>

<script src="/static/libs/cubismcore/live2dcubismcore.min.js"></script>
<script src="/static/libs/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
<script src="/static/libs/npm/pixi.js@7/dist/pixi.min.js"></script>
<script src="/static/libs/gh/RaSan147/pixi-live2d-display@v0.5.0-ls-6/dist/index.min.js"></script>

<script>
    (async function () {
        const app = new PIXI.Application({
            view: document.getElementById('live2d-canvas'), resizeTo: document.getElementById('live2d-container'),
            autoStart: true, transparent: true, backgroundAlpha: 0
        });
        window.PIXI = PIXI;
        const statusDiv = document.getElementById('status');
        let currentModel = null;
        let currentModelInfo = null;

        // åŠ è½½ç”¨æˆ·åå¥½
        async function loadUserPreferences() {
            try {
                const response = await fetch('/api/preferences');
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.warn('åŠ è½½ç”¨æˆ·åå¥½å¤±è´¥:', error);
            }
            return [];
        }

        // ä¿å­˜ç”¨æˆ·åå¥½
        async function saveUserPreferences() {
            if (!currentModel || !currentModelInfo) {
                statusDiv.innerText = "æ²¡æœ‰å¯ä¿å­˜çš„è®¾ç½®";
                return;
            }

            try {
                const preferences = {
                    model_path: currentModelInfo.path,
                    position: {
                        x: currentModel.x,
                        y: currentModel.y
                    },
                    scale: {
                        x: currentModel.scale.x,
                        y: currentModel.scale.y
                    }
                };

                const response = await fetch('/api/preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(preferences)
                });

                const result = await response.json();
                if (result.success) {
                    statusDiv.innerText = "è®¾ç½®å·²ä¿å­˜ï¼";
                    setTimeout(() => {
                        if (currentModelInfo) {
                            statusDiv.innerText = `å½“å‰æ¨¡å‹: ${currentModelInfo.name}`;
                        }
                    }, 2000);
                } else {
                    statusDiv.innerText = `ä¿å­˜å¤±è´¥: ${result.error}`;
                }
            } catch (error) {
                console.error("ä¿å­˜åå¥½å¤±è´¥:", error);
                statusDiv.innerText = "ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥";
            }
        }

        async function setupModelList() {
            try {
                const response = await fetch('/api/models');
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                const modelsFromServer = await response.json();
                const modelListContainer = document.getElementById('model-list-container');
                modelListContainer.innerHTML = '';
                
                if (modelsFromServer.length > 0) {
                    modelsFromServer.forEach(modelInfo => {
                        const btn = document.createElement('button');
                        btn.innerText = modelInfo.name;
                        btn.className = 'model-select-btn';
                        btn.onclick = async () => { 
                            const preferences = await loadUserPreferences();
                            // æŸ¥æ‰¾è¯¥æ¨¡å‹çš„å†å²åå¥½
                            const modelPreferences = preferences.find(pref => pref.model_path === modelInfo.path);
                            await loadModel(modelInfo, modelPreferences || null); 
                            
                            // å°†è¯¥æ¨¡å‹è®¾ä¸ºé¦–é€‰
                            try {
                                await fetch('/api/preferences/set-preferred', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ model_path: modelInfo.path })
                                });
                            } catch (error) {
                                console.warn('è®¾ç½®é¦–é€‰æ¨¡å‹å¤±è´¥:', error);
                            }
                            
                            modelListContainer.style.display = 'none'; 
                            document.getElementById('changeModelBtn').innerText = 'ğŸ”„ï¸ æ›´æ¢æ¨¡å‹'; 
                        };
                        modelListContainer.appendChild(btn);
                    });
                    
                    // åŠ è½½ç”¨æˆ·åå¥½
                    const preferences = await loadUserPreferences();
                    console.log('åŠ è½½çš„ç”¨æˆ·åå¥½:', preferences);
                    let modelToLoad = modelsFromServer[0]; // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªæ¨¡å‹
                    let modelPreferences = null;
                    
                    // å¦‚æœæœ‰ä¿å­˜çš„åå¥½ï¼Œå°è¯•æ‰¾åˆ°å¯¹åº”çš„æ¨¡å‹
                    if (preferences.length > 0 && preferences[0].model_path) {
                        const savedModel = modelsFromServer.find(model => model.path === preferences[0].model_path);
                        console.log('æŸ¥æ‰¾ä¿å­˜çš„æ¨¡å‹:', preferences[0].model_path, 'æ‰¾åˆ°:', savedModel);
                        if (savedModel) {
                            modelToLoad = savedModel;
                            modelPreferences = preferences[0];
                            statusDiv.innerText = `å‘ç° ${modelsFromServer.length} ä¸ªæ¨¡å‹ï¼Œæ­£åœ¨åŠ è½½é¦–é€‰æ¨¡å‹: ${savedModel.name}`;
                        } else {
                            statusDiv.innerText = `å‘ç° ${modelsFromServer.length} ä¸ªæ¨¡å‹ï¼Œé¦–é€‰æ¨¡å‹ä¸å¯ç”¨ï¼ŒåŠ è½½é»˜è®¤æ¨¡å‹ã€‚`;
                        }
                    } else {
                        statusDiv.innerText = `å‘ç° ${modelsFromServer.length} ä¸ªæ¨¡å‹ï¼Œè¯·ç‚¹å‡»æŒ‰é’®é€‰æ‹©ã€‚`;
                    }
                    
                    // åŠ è½½æ¨¡å‹å¹¶åº”ç”¨åå¥½è®¾ç½®
                    await loadModel(modelToLoad, modelPreferences);
                } else {
                    statusDiv.innerText = 'æœåŠ¡å™¨çš„ "static" æ–‡ä»¶å¤¹ä¸‹æœªå‘ç°ä»»ä½•æ¨¡å‹ã€‚';
                }
            } catch (error) { console.error("è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:", error); statusDiv.innerText = 'è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚'; }
        }

        async function loadModel(modelInfo, preferences = {}) {
            if (!modelInfo || !modelInfo.path) { statusDiv.innerText = "é”™è¯¯ï¼šæ¨¡å‹è·¯å¾„æ— æ•ˆã€‚"; return; }
            if (currentModel) { app.stage.removeChild(currentModel); currentModel.destroy({ children: true }); }
            
            currentModelInfo = modelInfo;
            statusDiv.innerText = `æ­£åœ¨åŠ è½½æ¨¡å‹: ${modelInfo.name}...`;
            try {
                const model = await PIXI.live2d.Live2DModel.from(modelInfo.path);
                currentModel = model;
                
                // åº”ç”¨ç”¨æˆ·åå¥½æˆ–ä½¿ç”¨é»˜è®¤è®¾ç½®
                console.log('åº”ç”¨åå¥½è®¾ç½®:', preferences);
                if (preferences && preferences.scale && preferences.position) {
                    // ä½¿ç”¨ä¿å­˜çš„åå¥½è®¾ç½®
                    console.log('ä½¿ç”¨ä¿å­˜çš„è®¾ç½® - ç¼©æ”¾:', preferences.scale, 'ä½ç½®:', preferences.position);
                    model.scale.set(preferences.scale.x, preferences.scale.y);
                    model.x = preferences.position.x;
                    model.y = preferences.position.y;
                    model.anchor.set(0.65, 0.75); // ç¡®ä¿è®¾ç½®anchor
                    statusDiv.innerText = `åŠ è½½æˆåŠŸ: ${modelInfo.name}ï¼Œå·²åº”ç”¨ä¿å­˜çš„è®¾ç½®ã€‚`;
                } else {
                    console.log('ä½¿ç”¨é»˜è®¤è®¾ç½®');
                    // ä½¿ç”¨é»˜è®¤è®¾ç½®
                    if (false) {
                        const scale = Math.min(0.5, window.innerHeight * 1.3 / 4000, window.innerWidth * 1.2 / 2000);
                        model.scale.set(scale);
                        model.x = app.renderer.width * 0.5;
                        model.y = app.renderer.height * 0.28;
                        model.anchor.set(0.5, 0.1);
                    } else {
                        const scale = Math.min(0.5, (window.innerHeight * 0.75) / 7000, (window.innerWidth * 0.6) / 7000);
                        model.scale.set(scale);
                        model.x = app.renderer.width;
                        model.y = app.renderer.height;
                        model.anchor.set(0.65, 0.75);
                    }
                    statusDiv.innerText = `åŠ è½½æˆåŠŸ: ${modelInfo.name}ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®ã€‚`;
                }

                app.stage.addChild(model);

                

                model.interactive = true;
                app.stage.interactive = true;
                app.stage.hitArea = app.screen;
                let isDragging = false;
                let dragStartPos = new PIXI.Point();

                model.on('pointerdown', (event) => {
                    isDragging = true;
                    // è®°å½•é¼ æ ‡ç‚¹å‡»ä½ç½®ç›¸å¯¹äºæ¨¡å‹çš„åç§»é‡
                    const globalPos = event.data.global;
                    dragStartPos.x = globalPos.x - model.x;
                    dragStartPos.y = globalPos.y - model.y;

                    document.getElementById('live2d-canvas').style.cursor = 'grabbing';
                });

                const onDragEnd = () => {
                    if (isDragging) {
                        isDragging = false;
                        document.getElementById('live2d-canvas').style.cursor = 'grab';
                    }
                };
                app.stage.on('pointerup', onDragEnd);
                app.stage.on('pointerupoutside', onDragEnd);

                app.stage.on('pointermove', (event) => {
                    if (isDragging) {
                        // ä½¿ç”¨é¼ æ ‡ä½ç½®å‡å»åç§»é‡æ¥è®¾ç½®æ¨¡å‹ä½ç½®
                        const newPosition = event.data.global;
                        model.x = newPosition.x - dragStartPos.x;
                        model.y = newPosition.y - dragStartPos.y;
                    }
                });

                const onWheelScroll = (event) => { if (!currentModel) return; event.preventDefault(); const scaleFactor = 1.1; const oldScale = currentModel.scale.x; let newScale = event.deltaY < 0 ? oldScale * scaleFactor : oldScale / scaleFactor; currentModel.scale.set(newScale); };
                const view = app.view;
                if (view.lastWheelListener) { view.removeEventListener('wheel', view.lastWheelListener); }
                view.addEventListener('wheel', onWheelScroll, { passive: false });
                view.lastWheelListener = onWheelScroll;
                
                // ä¿æŒä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œä¸è¦†ç›–åå¥½åº”ç”¨ä¿¡æ¯
                if (!preferences.scale || !preferences.position) {
                    statusDiv.innerText = `åŠ è½½æˆåŠŸ: ${modelInfo.name}ã€‚æ‚¨å¯ä»¥æ‹–æ‹½å’Œæ»šè½®ç¼©æ”¾æ¨¡å‹ã€‚`;
                }
                document.getElementById('savePreferencesBtn').disabled = false;
            } catch (error) { console.error("åŠ è½½æ¨¡å‹å¤±è´¥:", error); statusDiv.innerText = `åŠ è½½æ¨¡å‹ "${modelInfo.name}" å¤±è´¥ã€‚è¯·æ£€æŸ¥è·¯å¾„æˆ–F12æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ã€‚`; }
        }

        document.getElementById('changeModelBtn').addEventListener('click', () => {
            const modelListContainer = document.getElementById('model-list-container');
            const isVisible = modelListContainer.style.display === 'flex';
            if (isVisible) {
                modelListContainer.style.display = 'none';
                document.getElementById('changeModelBtn').innerText = 'ğŸ”„ï¸ æ›´æ¢æ¨¡å‹';
            } else {
                modelListContainer.style.display = 'flex';
                document.getElementById('changeModelBtn').innerText = 'ğŸ”¼ æ”¶èµ·åˆ—è¡¨';
                statusDiv.innerText = "è‡ªåŠ¨æ£€ç´¢Live2Dæ¨¡å‹...\nè¯·å°†æ¨¡å‹æ–‡ä»¶ç½®äº\n/staticæ–‡ä»¶å¤¹å†…ã€‚";
            }
        });

        // ä¿å­˜åå¥½æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('savePreferencesBtn').addEventListener('click', saveUserPreferences);
        
        setupModelList();

    })();
</script>

</body>
</html>